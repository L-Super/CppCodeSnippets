# 进程管理

**程序顺序执行特征**

+ 顺序性：处理机的操作严格按照程序所规定的顺序执行
+ 封闭性：程序是在封闭的环境下执行的，即程序运行时独占全机资源，资源的状态(除初始状态外)只有本程序才能改变它。程序一旦开始执行，其执行结果不受外界因素影响。
+ 可再现性：只要程序执行时的环境和初始条件相同，当程序重复执行时，不论它是从头到尾不停顿地执行，还是“停停走走”地执行，都将获得相同的结果。

**程序并发执行特征**

+ 间断性：程序在并发执行时，由于它们共享系统资源，以及为完成同一项任务而相互合作，致使在这些并发执行的程序之间，形成了相互制约的关系。
+ 失去封闭性：程序在并发执行时，是多个程序共享系统中的各种资源，因而这些资源的状态将由多个程序来改变，致使程序的运行失去了封闭性。
+ 不可再现性：程序在并发执行时，由于失去了封闭性，也将导致其再失去可再现性。

## 进程的描述

一般情况下，进程实体简称进程。

进程：在系统中能独立运行并作为资源分配的基本单位。

多个进程之间可以并发执行和交换信息。

**进程特征**

+ 动态性：进程的实质是进程实体的一次执行过程，“它由创建而产生，由调度而执行，由撤消而消亡”。
+ [[并行与并发|并发性]]：指多个进程实体同存于内存中，且能在一段时间内同时运行。
+ 独立性：指进程实体是一个能独立运行、独立分配资源和独立接受调度的基本单位。
+ 异步性：指进程按各自独立的、 不可预知的速度向前推进，或说进程实体按异步方式运行。

**进程三种基本状态**

+ 就绪状态（Ready）：当进程已分配到除 CPU 以外的所有必要资源后，只要再获得 CPU，便可立即执行，进程这时的状态称为就绪状态。

  在一个系统中处于就绪状态的进程可能有多个，通常将它们排成一个队列，称为就绪队列。

+ 执行状态（Running）：进程已获得 CPU，其程序正在执行。在单处理机系统中，只有一个进程处于执行状态；
  在多处理机系统中，则有多个进程处于执行状态。

+ 阻塞状态（Block）：正在执行的进程由于发生某事件（请求 I/O，申请缓冲区失败等）而暂时无法继续执行时，亦即进程的执行受到阻塞。此时引起进程调度，OS把处理机分配给另一个就绪进程，而让受阻进程处于暂停状态，把这种暂停状态称为阻塞状态，有时也称为等待状态或封锁状态。
  通常将这种处于阻塞状态的进程也排成一个队列。有的系统则根据阻塞原因的不同而把处于阻塞状态的进程排成多个队列。

### 进程管理中的数据结构

**操作系统中用于管理控制的数据结构**

在计算机系统中，对于每个资源和每个进程都设置了一个数据结构，用于表征其实体，称之为资源信息表或进程信息表，包含了资源或进程的标识、描述、状态等信息以及一批指针。

![image-20210813211523395](计算机操作系统.assets/image-20210813211523395.png)



OS管理的这些数据结构一般分为：内存表、设备表、文件表和用于进程管理的进程表，进程表又称为进程控制块PCB。

**进程控制块PCB的作用**

为了便于系统描述和管理进程的运行，在OS的核心为每个进程专门定义了一个数据结构——**进程控制块PCB（Process Control Block）**。PCB作为进程实体的一部分，记录操作系统所需的，用于描述进程的当前情况以及管理进程运行的全部信息，是操作系统中最重要的记录型数据结构。

PCB的作用是使一个在多道程序环境下不能独立运行的程序（含数据）成为一个能独立运行的基本单位，一个能与其他进程并发执行的进程。

具体作用：

+ 作为独立运行的基本单位的标志
+ 能实现间断性运行方式
+ 提供进程管理所需要的信息
+ 提供进程调度所需要的信息
+ 是心啊与其他进程的同步与通信

**进程控制块中的信息**

+ 进程标志符
  + 内部标识符
  + 外部标识符
+ 处理机状态
+ 进程调度信息
+ 进程控制信息

## 进程控制

进程控制是进程管理中最基本的功能，主要包括创建新进程、终止已完成的进程、将因发生异常情况而无法继续运行的进程置于阻塞状态、负责进程运行中的状态转换等功能。

### 操作系统内核

处理机执行状态分为系统态和用户态：

+ 系统态：又称管态，也称内核态。具有较高的特权，能执行一切指令，访问所有寄存器和存储区，传统的OS都在系统态执行。
+ 用户态：又称目态。具有较低的特权执行状态，仅能执行锁定的指令，访问指定的寄存器和存储区。一般情况下，应用程序只能在用户态执行。

OS内核包含两大方面功能：

+ 支撑功能：
  + 中断处理
  + 时钟管理
  + 原语操作
+ 资源管理功能：
  + 进程管理
  + 存储器管理
  + 设备管理

### 进程的创建

**进程的层次结构**

在OS中，允许进程创建另一个进程，通常把创建进程的进程称为父进程，把被创建的进程称为子进程。子进程可继续创建多个孙进程。

子进程可继承父进程所拥有的资源。子进程撤销时，应将资源归还给父进程；撤销父进程时，也必须同时撤销所有子进程。

注：Windows中不存在任何进程层次结构的概念，所有进程具有相同的地位。

**引起创建进程的事件**

+ 用户登录
+ 作业调度
+ 提供服务
+ 应用请求

**进程的创建**

当出现创建新进程的请求后，OS调用进程创建原语Creat按下述步骤创建新进程：

1. 申请空白PCB，为新进程申请获得唯一的数字标识符，并从PCB集合中索取一个空白PCB。
2. 为新进程分配其运行所需的资源，包括各种物理和逻辑资源，如内存、文件、I/O设备和CPU时间等。
3. 初始化进程控制块（PCB）
4. 如果进程就绪队列能够接纳新进程，便将新进程插入就绪队列。

### 进程的终止
**引起进程终止的事件**
1. 正常结束，表示表示进程的任务已经完成，准备退出运行。
2. 异常结束，是指进程在运行时发生了某种异常事件，使程序无法继续运行。
3. 外界干预，指进程应外界的请求而终止运行。

### 进程同步
为保证多个进程有条不紊地运行，在多道程序系统中，必须引入进程同步机制。
#### 进程同步基本概念
进程同步机制的主要任务,是对多个相关进程在执行次序上进行协调,使并发执行的诸进程之间能按照一定的规则(或时序)共享系统资源,并能很好地相互合作,从而使程序的执行具有可再现性
1. 两种形式的制约关系
	1. 间接相互制约关系
	2. 直接相互制约关系

2. 临界资源
3. 临界区
4. 同步机制应遵循的规则
	1. 空闲让进
	2. 忙则等待
	3. 有限等待
	4. 让权等待

#### 硬件同步机制
1. 关中断
在进入锁测试之前关闭中断，直到完成锁测试并上锁之后才能打开中断。
 缺点：
+ 滥用关中断权力可能导致严重后果
+ 关中断时间过长,会影响系统效率,限制了处理器交叉执行程序的能力
+ 关中断方法也不适用于多CPU系统,因为在一个处理器上关中断并不能防止进程在其它处理器上执行相同的临界段代码。

2. 利用Test-and-Set指令实现互斥
这是一种借助一条硬件指令——“测试并建立”指令TS( Test-and-Set以实现互斥的方
法。在许多计算机中都提供了这种指令。TS指令的一般性描述如下:
```
boolean TS(boolean *lock)
Boolean old;
old = *lock;
*lock= TRUE;
return old;
```

这条指令可以看作为一个函数过程，其执行过程是不可分割的，即是一条原语。其中，lock有两种状态：当lock = FALSE时，表示该资源空闲；当lock =TRUE时，表示该资源正在被使用。

用TS指令管理临界区时，为每个临界资源设置一个布尔变量lock，由于变量lock代表了该资源的状态，故可把它看成一把锁。lock初值为 FALSE，表示该临界资源空闲。进程在进入临界区之前，首先用TS指令测试lock，如果其值为 FALSE，则表示没有进程在临界区内，可以进入，并将TRUE值赋予lock，这等效于关闭了临界资源，使任何进程都不能进入临界区，否则必须循环测试直到TS(s)为TRUE。利用TS指令实现互斥的循环进程结构可描述如下:
```
do{
...
while TS(&lock);/*do skip*/
critical section:
lock := FALSE;
remainder section;
J while(TRUE);
```

3. 利用Swap指令实现进程互斥

该指令称为对换指令,在 Intel 80x86中又称为XCHG指令,用于交换两个字的内容。
其处理过程描述如下:
```
void swap(boolean *a, boolean *b)
{
	boolean temp;
	temp = *a;
	*a = *b;
	*b = temp;
}
```
用对换指令可以简单有效地实现互斥,方法是为每个临界资源设置一个全局的布尔变量lock,其初值为 false,在每个进程中再利用一个局部布尔变量key。利用Swap指令实现进程互斥的循环进程可描述如下:
```
do{
	key=TRUE;
	do{
		swap(&lock, &key);	
	}while(key != FALSE);
	临界区操作;
	lock= FALSE;
	...
} while (TRUE);
```
利用上述硬件指令能有效地实现进程互斥,但当临界资源忙碌时,其它访问进程必须不断地进行测试,处于一种“忙等”状态,不符合“让权等待”的原则,造成处理机时间的浪费,同时也很难将它们用于解决复杂的进程同步问题。

#### 信号量机制
1. 整型信号量
2. 记录型信号量
3. AND型信号量
4. 信号量集

#### 管程机制
虽然信号量机制是一种既方便、又有效的进程同步机制,但每个要访问临界资源的进程都必须自备同步操作wait(S)和 signale(S)。这就使大量的同步操作分散在各个进程中。这不仅给系统的管理带来了麻烦,而且还会因同步操作的使用不当而导致系统死锁。这样,在解决上述问题的过程中,便产生了一种新的进程同步工具管程( Monitors)

代表共享资源的数据结构以及由对该共享数据结构实施操作的一组过程所组成的资源管理程序共同构成了一个操作系统的资源管理模块，称之为管程。

管程由四部分组成：
1. 管程的名称
2. 局部于管程的共享数据说明
3. 对该数据结构进行操作的一组过程
4. 对局部于管程的共享数据设置初始值的语句

管程特性：
1. 模块化
2. 抽象数据类型
3. 信息掩蔽

管程和进程异同:
+ 虽然二者都定义了数据结构，但进程定义的是私有数据结构PCB，管程定义的是公共数据结构，如消息队列等;
+ 二者都存在对各自数据结构上的操作，但进程是由顺序程序执行有关操作，而管程主要是进行同步操作和初始化操作;
+ 设置进程的目的在于实现系统的并发性，而管程的设置则是解决共享资源的互斥使用问题;
+ 进程通过调用管程中的过程对共亨数据结构实行操作，该过程就如通常的子程序一样被调用，因而管程为被动工作方式，进程则为主动工作方式;
+ 进程之间能并发执行，而管程则不能与其调用者并发;
+ 进程具有动态性，由“创建”而诞生，由“撤消”而消亡，而管程则是操作系统中的一个资源管理模块,供进程调用。